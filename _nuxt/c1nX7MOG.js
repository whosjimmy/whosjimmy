import{V as G,r as d,d as ue,u as ce,s as de,A as ve,a as he,y as be,c as y,b as o,i as D,W as pe,f as B,Q as C,h as P,t as f,N as ge,O as fe,e as F,n as we,g as me,w as ke,P as ye,j as Se,o as S,_ as Ce}from"./CSUAcl7G.js";import{u as _e}from"./BgDxab8W.js";const $e=()=>{const w=G().public.YOUTUBE_API_KEY,b="https://www.googleapis.com/youtube/v3",u=d(!1),r=d(null);return{loading:u,error:r,checkSubscription:async(l,a)=>{u.value=!0,r.value=null;try{console.log("Checking subscription for channel:",l);const s=await fetch(`${b}/subscriptions?part=snippet&mine=true&forChannelId=${l}&key=${w}`,{headers:{Authorization:`Bearer ${a}`}});if(!s.ok){const c=await s.text();throw console.error("Subscription check failed:",s.status,c),new Error(`API error: ${s.status}`)}const n=await s.json();return console.log("Subscription response:",n),{isSubscribed:!!(n.items&&n.items.length>0),subscriptionId:n.items?.[0]?.id}}catch(s){const n=s;return console.error("Error checking subscription:",n),r.value=n.message,{isSubscribed:!1}}finally{u.value=!1}},subscribeToChannel:async(l,a)=>{u.value=!0,r.value=null;try{const s=await fetch(`${b}/subscriptions?part=snippet&key=${w}`,{method:"POST",headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"},body:JSON.stringify({snippet:{resourceId:{kind:"youtube#channel",channelId:l}}})});if(!s.ok)throw new Error(`Failed to subscribe: ${s.status}`);return!0}catch(s){const n=s;return console.error("Error subscribing:",n),r.value=n.message,!1}finally{u.value=!1}},unsubscribeFromChannel:async(l,a)=>{u.value=!0,r.value=null;try{const s=await fetch(`${b}/subscriptions?id=${l}&key=${w}`,{method:"DELETE",headers:{Authorization:`Bearer ${a}`}});if(!s.ok&&s.status!==204)throw new Error(`Failed to unsubscribe: ${s.status}`);return!0}catch(s){const n=s;return console.error("Error unsubscribing:",n),r.value=n.message,!1}finally{u.value=!1}},checkLikeStatus:async(l,a)=>{u.value=!0,r.value=null;try{const s=await fetch(`${b}/videos/getRating?id=${l}&key=${w}`,{headers:{Authorization:`Bearer ${a}`}});if(!s.ok)throw new Error(`API error: ${s.status}`);const c=(await s.json()).items?.[0]?.rating||"none";return{isLiked:c==="like",rating:c}}catch(s){const n=s;return console.error("Error checking like status:",n),r.value=n.message,{isLiked:!1,rating:"none"}}finally{u.value=!1}},likeVideo:async(l,a)=>{u.value=!0,r.value=null;try{const s=await fetch(`${b}/videos/rate?id=${l}&rating=like&key=${w}`,{method:"POST",headers:{Authorization:`Bearer ${a}`,"Content-Length":"0"}});if(!s.ok&&s.status!==204)throw new Error(`Failed to like video: ${s.status}`);return!0}catch(s){const n=s;return console.error("Error liking video:",n),r.value=n.message,!1}finally{u.value=!1}},unlikeVideo:async(l,a)=>{u.value=!0,r.value=null;try{const s=await fetch(`${b}/videos/rate?id=${l}&rating=none&key=${w}`,{method:"POST",headers:{Authorization:`Bearer ${a}`,"Content-Length":"0"}});if(!s.ok&&s.status!==204)throw new Error(`Failed to unlike video: ${s.status}`);return!0}catch(s){const n=s;return console.error("Error unliking video:",n),r.value=n.message,!1}finally{u.value=!1}},batchCheckLikes:async(l,a)=>{const s=new Map,n=l.join(",");try{console.log("Checking likes for videos:",l.length);const c=await fetch(`${b}/videos/getRating?id=${n}&key=${w}`,{headers:{Authorization:`Bearer ${a}`}});if(!c.ok){const m=await c.text();throw console.error("Batch like check failed:",c.status,m),new Error(`API error: ${c.status}`)}const g=await c.json();console.log("Like ratings response:",g),g.items?.forEach(m=>{s.set(m.videoId,{isLiked:m.rating==="like",rating:m.rating})}),console.log("Processed",s.size,"like statuses")}catch(c){const g=c;console.error("Error batch checking likes:",g),r.value=g.message}return s}}},xe={class:"youtube-videos"},Ee={class:"subscribe-section"},Ie=["disabled"],Ae={key:0,class:"loading"},Te={key:1,class:"error"},Le={key:2,class:"videos-grid"},Me=["onMouseenter","onClick"],Ve={class:"video-thumbnail"},Be=["src","alt"],Pe=["src"],ze={class:"video-info"},Ue={class:"video-title"},De={class:"video-description"},Fe={class:"video-meta"},Re={class:"publish-date"},Ye=["disabled","onClick"],qe={class:"modal-video-container"},je=["src"],Ne={class:"modal-video-info"},Oe={class:"modal-actions"},We=["disabled"],He=["disabled"],Ke={class:"modal-video-title"},Ge={class:"modal-video-meta"},Je={class:"modal-publish-date"},Qe={class:"modal-video-description"},Xe={class:"dialog-checkbox"},Ze=ue({__name:"Videos",setup(J){const w=G(),b=ce(),{hasYouTubeAccess:u,youtubeAccessToken:r}=de(b),_=_e(),p=$e(),$=d([]),L=d(!1),x=d(null),E=w.public.YOUTUBE_CHANNEL_ID||"UCPraC_i-mKFuwq17vUsrzWg",I=d(null),l=d(null),a=d(null),s=d(!1),n=d(!1),c=d(null),g=d({}),m=new Map,M=d(!1),A=d(!1),z=d(!1),v=ve({isSubscribed:!1,subscriptionId:void 0}),k=d(new Map),R=async()=>{L.value=!0,x.value=null;try{const t=`https://www.youtube.com/feeds/videos.xml?channel_id=${E}`,e=`https://api.allorigins.win/get?url=${encodeURIComponent(t)}`,i=await fetch(e),h=await i.json();if(!i.ok)throw new Error("Failed to fetch videos");const ie=new DOMParser().parseFromString(h.contents,"text/xml").querySelectorAll("entry");$.value=Array.from(ie).map(T=>{const K=T.querySelector("videoId")?.textContent||"",ne=T.querySelector("title")?.textContent||"",ae=T.querySelector("media\\:description, description")?.textContent||"",re=T.querySelector("published")?.textContent||"",le=T.querySelector("media\\:thumbnail, thumbnail")?.getAttribute("url")||`https://img.youtube.com/vi/${K}/mqdefault.jpg`;return{id:K,title:ne,description:ae,publishedAt:re,thumbnail:le}}),u.value&&r.value&&await Y()}catch(t){const e=t;x.value=e.message,console.error("Error fetching YouTube videos:",e)}finally{L.value=!1}},U=async()=>{const t=r.value;if(!t)return;const e=await p.checkSubscription(E,t);v.isSubscribed=e.isSubscribed,v.subscriptionId=e.subscriptionId},Y=async()=>{const t=r.value;if(!t||$.value.length===0)return;const e=$.value.map(h=>h.id),i=await p.batchCheckLikes(e,t);k.value=i},q=async()=>{if(!u.value){if(typeof window<"u"?localStorage.getItem("youtube_skip_signin")==="true":!1){const i=`https://www.youtube.com/channel/${E}?sub_confirmation=1`;window.open(i,"_blank");return}M.value=!0;return}const t=r.value;t&&(v.isSubscribed&&v.subscriptionId?await p.unsubscribeFromChannel(v.subscriptionId,t)&&(v.isSubscribed=!1,v.subscriptionId=void 0):await p.subscribeToChannel(E,t)&&await U())},j=async t=>{if(!u.value){if(typeof window<"u"?localStorage.getItem("youtube_skip_signin")==="true":!1){const H=`https://www.youtube.com/watch?v=${t}`;window.open(H,"_blank");return}M.value=!0;return}const e=r.value;if(!e)return;k.value.get(t)?.isLiked?await p.unlikeVideo(t,e)&&k.value.set(t,{isLiked:!1,rating:"none"}):await p.likeVideo(t,e)&&k.value.set(t,{isLiked:!0,rating:"like"})},Q=async()=>{A.value&&(localStorage.setItem("ytSignInPromptDismissed","true"),z.value=!0),V(),await _.signInWithYouTube()&&_.state.value.accessToken?(console.log("Sign-in successful, fetching YouTube data..."),b.setYouTubeAccess(_.state.value.accessToken),_.state.value.user&&(await Se().upsertUserProfile(_.state.value.user,!1),console.log("User profile updated in Firestore")),console.log("Fetching subscription status..."),await U(),console.log("Subscription status:",v),console.log("Fetching like statuses for",$.value.length,"videos..."),await Y(),console.log("Like statuses:",k.value)):console.error("Sign-in failed or no access token")},X=()=>{A.value&&(localStorage.setItem("ytSignInPromptDismissed","true"),z.value=!0),V(),typeof window<"u"&&localStorage.setItem("youtube_skip_signin","true")},V=()=>{M.value=!1,A.value=!1},Z=t=>{a.value||(l.value=setTimeout(()=>{I.value=t},300))},N=()=>{l.value&&(clearTimeout(l.value),l.value=null),I.value=null},ee=(t,e)=>{t&&m.set(e,t)},te=t=>{N();const e=m.get(t.id);if(!e)return;const i=e.getBoundingClientRect();c.value=t.id,g.value={position:"fixed",top:`${i.top}px`,left:`${i.left}px`,width:`${i.width}px`,height:`${i.height}px`,borderRadius:"12px"},a.value=t,s.value=!0,document.body.style.overflow="hidden",requestAnimationFrame(()=>{requestAnimationFrame(()=>{se()})})},se=()=>{const t=window.innerWidth,e=window.innerHeight,i=Math.min(t*.9,1200),h=Math.min(e*.9,800);g.value={position:"fixed",top:`${(e-h)/2}px`,left:`${(t-i)/2}px`,width:`${i}px`,height:`${h}px`,borderRadius:"16px"},n.value=!0},O=()=>{const t=m.get(a.value?.id||"");if(t){const e=t.getBoundingClientRect();g.value={position:"fixed",top:`${e.top}px`,left:`${e.left}px`,width:`${e.width}px`,height:`${e.height}px`,borderRadius:"12px"}}n.value=!1,setTimeout(()=>{a.value=null,s.value=!1,c.value=null,g.value={},document.body.style.overflow=""},400)},oe=(t,e=150)=>t?t.length>e?t.substring(0,e)+"...":t:"",W=t=>new Date(t).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"});return he(async()=>{await R(),z.value=localStorage.getItem("ytSignInPromptDismissed")==="true",_.initializeYouTubeAuth(),u.value&&r.value&&await U(),be(()=>b.user,t=>{t||(console.log("User logged out, clearing YouTube data"),v.isSubscribed=!1,v.subscriptionId=void 0,k.value.clear())})}),(t,e)=>(S(),y("div",xe,[e[13]||(e[13]=o("div",{class:"banner"},[o("img",{src:pe,alt:"Channel Banner"})],-1)),o("div",Ee,[o("button",{class:C(["subscribe-btn",{subscribed:v.isSubscribed}]),disabled:B(p).loading.value,onClick:q},[e[4]||(e[4]=o("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"currentColor"},[o("path",{d:"M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"})],-1)),P(" "+f(v.isSubscribed?"Subscribed":"Subscribe"),1)],10,Ie)]),L.value?(S(),y("div",Ae,"Loading videos...")):x.value?(S(),y("div",Te,[P(" Error loading videos: "+f(x.value)+" ",1),o("button",{class:"btn",onClick:R},"Retry")])):(S(),y("div",Le,[(S(!0),y(ge,null,fe($.value,i=>(S(),y("div",{key:i.id,ref_for:!0,ref:h=>ee(h,i.id),class:C(["video-card",{"is-expanding":c.value===i.id}]),onMouseenter:h=>Z(i.id),onMouseleave:N,onClick:h=>te(i)},[o("div",Ve,[o("img",{src:i.thumbnail,alt:i.title,class:C(["thumbnail-static",{"fade-out":I.value===i.id}])},null,10,Be),I.value===i.id&&!a.value?(S(),y("iframe",{key:0,src:`https://www.youtube.com/embed/${i.id}?autoplay=1&mute=1&controls=0&showinfo=0&rel=0&modestbranding=1&loop=1&playlist=${i.id}`,class:"video-preview",frameborder:"0",allow:"autoplay; encrypted-media",allowfullscreen:""},null,8,Pe)):D("",!0),e[5]||(e[5]=o("div",{class:"play-overlay"},"▶",-1)),e[6]||(e[6]=o("div",{class:"hover-progress"},null,-1))]),o("div",ze,[o("h3",Ue,f(i.title),1),o("p",De,f(oe(i.description)),1),o("div",Fe,[o("span",Re,f(W(i.publishedAt)),1),o("button",{class:C(["like-btn-small",{liked:k.value.get(i.id)?.isLiked}]),disabled:B(p).loading.value,title:"Like this video",onClick:F(h=>j(i.id),["stop"])},e[7]||(e[7]=[o("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[o("path",{d:"M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"})],-1)]),10,Ye)])])],42,Me))),128))])),a.value?(S(),y("div",{key:3,class:C(["video-modal-overlay",{"is-visible":s.value}]),onClick:O},[e[10]||(e[10]=o("div",{class:"video-modal-backdrop"},null,-1)),o("div",{class:C(["video-modal",{"is-expanded":n.value}]),style:we(g.value),onClick:e[1]||(e[1]=F(()=>{},["stop"]))},[o("button",{class:"modal-close-btn","aria-label":"Close video",onClick:O}," ✕ "),o("div",qe,[o("iframe",{src:`https://www.youtube.com/embed/${a.value.id}?autoplay=1&controls=1&showinfo=0&rel=0&modestbranding=1&enablejsapi=1`,class:"modal-video-player",frameborder:"0",allow:"autoplay; encrypted-media",allowfullscreen:""},null,8,je)]),o("div",Ne,[o("div",Oe,[o("button",{class:C(["modal-like-btn",{liked:k.value.get(a.value.id)?.isLiked}]),disabled:B(p).loading.value,onClick:e[0]||(e[0]=i=>j(a.value.id))},[e[8]||(e[8]=o("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[o("path",{d:"M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"})],-1)),P(" "+f(k.value.get(a.value.id)?.isLiked?"Liked":"Like"),1)],10,We),o("button",{class:C(["modal-subscribe-btn",{subscribed:v.isSubscribed}]),disabled:B(p).loading.value,onClick:q},[e[9]||(e[9]=o("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"currentColor"},[o("path",{d:"M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"})],-1)),P(" "+f(v.isSubscribed?"Subscribed":"Subscribe"),1)],10,He)]),o("h2",Ke,f(a.value.title),1),o("div",Ge,[o("span",Je,f(W(a.value.publishedAt)),1)]),o("p",Qe,f(a.value.description),1)])],6)],2)):D("",!0),M.value?(S(),y("div",{key:4,class:"dialog-overlay",onClick:V},[o("div",{class:"dialog",onClick:e[3]||(e[3]=F(()=>{},["stop"]))},[o("button",{class:"dialog-close",onClick:V}," ✕ "),e[12]||(e[12]=me('<div class="dialog-icon" data-v-b9a69602><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-v-b9a69602><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4" data-v-b9a69602></path><polyline points="10 17 15 12 10 7" data-v-b9a69602></polyline><line x1="15" y1="12" x2="3" y2="12" data-v-b9a69602></line></svg></div><h3 class="dialog-title" data-v-b9a69602>Sign in to YouTube</h3><p class="dialog-message" data-v-b9a69602> Sign in with Google to see your like and subscription status across all videos. You can interact with content directly from this page! </p>',3)),o("div",{class:"dialog-actions"},[o("button",{class:"btn btn-secondary",onClick:X}," Continue Without Signing In "),o("button",{class:"btn btn-primary",onClick:Q}," Sign In with Google ")]),o("label",Xe,[ke(o("input",{"onUpdate:modelValue":e[2]||(e[2]=i=>A.value=i),type:"checkbox"},null,512),[[ye,A.value]]),e[11]||(e[11]=o("span",null,"Don't show this again",-1))])])])):D("",!0)]))}}),ot=Ce(Ze,[["__scopeId","data-v-b9a69602"]]);export{ot as default};
